var QueryUtils={uuidv4:require("uuid/v4"),moment:require("moment"),mysql:require("mysql"),con:"",tokens:[],init:function(a,b){var c=require("fs"),d=require("ini"),e=require("util"),f=d.parse(c.readFileSync(b+"/data/"+a+"/client.ini.php","utf-8"));this.con=this.mysql.createPool({host:f.db.host,user:f.db.user,database:f.db.name,password:f.db.pass}),this.con.query=e.promisify(this.con.query)},writeChatServerConfig:async function(a,b,c){await this.con.query("INSERT INTO sr_chat_config (name, value) VALUES (\"ip\", \""+a+"\") ON DUPLICATE KEY UPDATE value = \""+a+"\""),await this.con.query("INSERT INTO sr_chat_config (name, value) VALUES (\"port\", \""+b+"\") ON DUPLICATE KEY UPDATE value = \""+b+"\""),await this.con.query("INSERT INTO sr_chat_config (name, value) VALUES (\"protocol\", \""+c+"\") ON DUPLICATE KEY UPDATE value = \""+c+"\"")},getOldMessages:async function(a){var b=this.con,c=this.moment,d=await b.query("SELECT m.*, u.login, u.firstname, u.lastname, p.value FROM sr_chat_message m LEFT JOIN usr_data u ON u.usr_id = m.usr_id LEFT JOIN usr_pref p ON p.usr_id = u.usr_id AND p.keyword = \"public_profile\" AND (p.value = \"y\" OR p.value = \"g\") WHERE m.chat_room_id = "+a+" ORDER BY sent_at ASC");return d=d.map(function(a){if(null==a.login)var b="[deleted]";else if(null==a.value)var b=a.login;else var b=a.firstname+" "+a.lastname+" ("+a.login+")";return Object.assign({},a,{sent_at:c(a.sent_at).format("HH:mm"),public_name:b})}),d},loadTokens:async function(){let a=this;var b=await this.con.query("SELECT * FROM sr_chat_token");a.tokens=[],b.forEach(function(b){a.tokens[b.token]=b}),await a.cleanupTokens()},cleanupTokens:async function(){var a=Math.round(new Date().getTime()/1e3);await this.con.query("DELETE FROM sr_chat_token WHERE valid_until_unix < "+a)},checkAndFetchToken:async function(a){var b=Math.round(new Date().getTime()/1e3);a in this.tokens||(await this.loadTokens());var c=this.tokens[a];if("undefined"!=typeof c&&c.valid_until_unix>b)return c;throw new Error("Token invalid"+("undefined"==typeof c?"":" (expired)"))},insertMessage:async function(a,b,c,d){await this.con.query("INSERT INTO sr_chat_message (id, chat_room_id, usr_id, message, sent_at) VALUES (\""+this.uuidv4()+"\","+a+","+b+",\""+c+"\", \""+d+"\")")}};module.exports=QueryUtils;